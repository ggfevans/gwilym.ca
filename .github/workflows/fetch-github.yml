name: Fetch GitHub Data

on:
  schedule:
    - cron: '17 3 * * *'  # Daily at 3:17 AM UTC (off-peak)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      GH_USER: ${{ github.repository_owner }}
    steps:
      - uses: actions/checkout@v4

      - name: Fetch GitHub activity
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p src/data

          # --- 1. Recent events (commits, PRs, issues) ---
          # Fetch up to 3 pages of events to get sufficient history
          EVENTS="[]"
          for PAGE in 1 2 3; do
            PAGE_DATA=$(curl -sf \
              --connect-timeout 10 \
              --max-time 30 \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${GH_USER}/events?per_page=100&page=${PAGE}" \
            ) || { echo "::warning::Failed to fetch events page ${PAGE}"; break; }

            echo "$PAGE_DATA" | jq empty 2>/dev/null || { echo "::warning::Invalid JSON on page ${PAGE}"; break; }
            EVENTS=$(echo "$EVENTS" "$PAGE_DATA" | jq -s '.[0] + .[1]')

            # Stop if fewer than 100 results (last page)
            COUNT=$(echo "$PAGE_DATA" | jq 'length')
            if [ "$COUNT" -lt 100 ]; then break; fi
          done

          EVENT_COUNT=$(echo "$EVENTS" | jq 'length')
          if [ "$EVENT_COUNT" -eq 0 ]; then
            echo "::warning::No events fetched — output will be sparse"
          fi

          # Extract PushEvent before/head pairs (API no longer includes commits in payload)
          PUSHES=$(echo "$EVENTS" | jq -c '[
            .[]
            | select(.type == "PushEvent" and .payload.before != null and .payload.head != null)
            | {
                repo: .repo.name,
                before: .payload.before,
                head: .payload.head,
                date: .created_at
              }
          ] | unique_by(.head)')

          # Fetch actual commits via Compare API for each push
          ALL_COMMITS="[]"
          for PUSH in $(echo "$PUSHES" | jq -c '.[]'); do
            REPO=$(echo "$PUSH" | jq -r '.repo')
            BEFORE=$(echo "$PUSH" | jq -r '.before')
            HEAD=$(echo "$PUSH" | jq -r '.head')
            DATE=$(echo "$PUSH" | jq -r '.date')

            COMPARE=$(curl -sf \
              --connect-timeout 10 \
              --max-time 30 \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/compare/${BEFORE}...${HEAD}" \
            ) || { echo "::warning::Failed to compare ${REPO} ${BEFORE}...${HEAD}"; continue; }

            PUSH_COMMITS=$(echo "$COMPARE" | jq --arg repo "$REPO" --arg date "$DATE" '[
              .commits[]
              | {
                  repo: ($repo | split("/") | last),
                  message: (.commit.message | split("\n") | first),
                  sha: .sha,
                  date: ((.commit.author.date // .commit.committer.date // $date) | if . == "" then $date else . end),
                  url: .html_url
                }
            ]' 2>/dev/null) || continue

            ALL_COMMITS=$(echo "$ALL_COMMITS" "$PUSH_COMMITS" | jq -s '.[0] + .[1]')
          done

          ALL_COMMITS=$(echo "$ALL_COMMITS" | jq 'unique_by(.sha) | sort_by(.date) | reverse')

          # --- 2. GraphQL: contribution calendar + stats ---
          GRAPHQL_QUERY='query($userName:String!){user(login:$userName){contributionsCollection{contributionCalendar{totalContributions weeks{contributionDays{contributionCount date contributionLevel}}}totalCommitContributions totalPullRequestContributions totalPullRequestReviewContributions totalIssueContributions restrictedContributionsCount}}}'

          GRAPHQL_RESPONSE=$(curl -sf \
            --connect-timeout 10 \
            --max-time 30 \
            -H "Authorization: bearer ${GH_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "{\"query\":\"${GRAPHQL_QUERY}\",\"variables\":{\"userName\":\"${GH_USER}\"}}" \
            "https://api.github.com/graphql" \
          ) || { echo "::warning::GraphQL query failed — contributions/calendar will be empty"; GRAPHQL_RESPONSE=""; }

          # Validate GraphQL response
          GRAPHQL_OK=false
          if [ -n "$GRAPHQL_RESPONSE" ]; then
            echo "$GRAPHQL_RESPONSE" | jq -e '.data.user.contributionsCollection' >/dev/null 2>&1 && GRAPHQL_OK=true
          fi

          if [ "$GRAPHQL_OK" = true ]; then
            echo "GraphQL contributions query succeeded"
            GQL_DATA=$(echo "$GRAPHQL_RESPONSE" | jq '.data.user.contributionsCollection')
          else
            if [ -n "$GRAPHQL_RESPONSE" ]; then
              echo "::warning::GraphQL response missing expected data — using fallbacks"
            fi
            GQL_DATA="null"
          fi

          # --- 3. Build contributions object ---
          if [ "$GQL_DATA" != "null" ]; then
            CONTRIBUTIONS=$(echo "$GQL_DATA" | jq '{
              total: .contributionCalendar.totalContributions,
              commits: .totalCommitContributions,
              pullRequests: .totalPullRequestContributions,
              pullRequestReviews: .totalPullRequestReviewContributions,
              issues: .totalIssueContributions,
              restricted: .restrictedContributionsCount
            }')
          else
            CONTRIBUTIONS='{"total":0,"commits":0,"pullRequests":0,"pullRequestReviews":0,"issues":0,"restricted":0}'
          fi

          # --- 4. Build calendar object ---
          if [ "$GQL_DATA" != "null" ]; then
            CALENDAR=$(echo "$GQL_DATA" | jq '{
              weeks: [.contributionCalendar.weeks[] | {
                days: [.contributionDays[] | {
                  date: .date,
                  count: .contributionCount,
                  level: (
                    if .contributionLevel == "NONE" then 0
                    elif .contributionLevel == "FIRST_QUARTILE" then 1
                    elif .contributionLevel == "SECOND_QUARTILE" then 2
                    elif .contributionLevel == "THIRD_QUARTILE" then 3
                    elif .contributionLevel == "FOURTH_QUARTILE" then 4
                    else 0
                    end
                  )
                }]
              }]
            }')
          else
            CALENDAR='{"weeks":[]}'
          fi

          # --- 5. Compute streak from calendar ---
          TODAY=$(date -u '+%Y-%m-%d')
          if [ "$GQL_DATA" != "null" ]; then
            STREAK=$(echo "$CALENDAR" | jq --arg today "$TODAY" '
              # Flatten all days and sort by date descending
              [.weeks[].days[]] | sort_by(.date) | reverse |

              # Current streak: consecutive days with count > 0 from most recent
              . as $days |
              {
                current: (
                  reduce .[] as $d (
                    { count: 0, active: true };
                    if .active and $d.count > 0 then { count: (.count + 1), active: true }
                    elif .active and $d.date == $today and $d.count == 0 then .
                    else { count: .count, active: false }
                    end
                  ) | .count
                ),
                longest: (
                  [.[] | .count > 0] | reduce .[] as $has_contrib (
                    { current: 0, max: 0 };
                    if $has_contrib then { current: (.current + 1), max: (if (.current + 1) > .max then .current + 1 else .max end) }
                    else { current: 0, max: .max }
                    end
                  ) | .max
                ),
                today: (map(select(.date == $today)) | if length > 0 then .[0].count > 0 else false end)
              }
            ')
          else
            STREAK='{"current":0,"longest":0,"today":false}'
          fi

          # --- 6. Stats: commits + contributions this week/month ---
          WEEK_AGO=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null \
            || date -u -v-7d '+%Y-%m-%dT%H:%M:%SZ')
          MONTH_AGO=$(date -u -d '30 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null \
            || date -u -v-30d '+%Y-%m-%dT%H:%M:%SZ')
          WEEK_AGO_DATE=$(date -u -d '7 days ago' '+%Y-%m-%d' 2>/dev/null \
            || date -u -v-7d '+%Y-%m-%d')
          MONTH_AGO_DATE=$(date -u -d '30 days ago' '+%Y-%m-%d' 2>/dev/null \
            || date -u -v-30d '+%Y-%m-%d')

          COMMITS_THIS_WEEK=$(echo "$ALL_COMMITS" | jq --arg since "$WEEK_AGO" \
            '[.[] | select(.date >= $since)] | length')
          COMMITS_THIS_MONTH=$(echo "$ALL_COMMITS" | jq --arg since "$MONTH_AGO" \
            '[.[] | select(.date >= $since)] | length')
          REPOS_THIS_WEEK=$(echo "$ALL_COMMITS" | jq --arg since "$WEEK_AGO" \
            '[.[] | select(.date >= $since) | .repo] | unique | length')

          # Contribution counts from calendar (broader than just commits)
          if [ "$GQL_DATA" != "null" ]; then
            CONTRIBS_THIS_WEEK=$(echo "$CALENDAR" | jq --arg since "$WEEK_AGO_DATE" \
              '[.weeks[].days[] | select(.date >= $since) | .count] | add // 0')
            CONTRIBS_THIS_MONTH=$(echo "$CALENDAR" | jq --arg since "$MONTH_AGO_DATE" \
              '[.weeks[].days[] | select(.date >= $since) | .count] | add // 0')
          else
            CONTRIBS_THIS_WEEK=0
            CONTRIBS_THIS_MONTH=0
          fi

          # --- 7. Build recentActivity from commits + PR/issue events ---
          # Transform commits to ActivityItem format
          COMMIT_ACTIVITY=$(echo "$ALL_COMMITS" | jq --arg owner "${GH_USER}" '[
            .[]
            | {
                type: "commit",
                repo: .repo,
                repoUrl: ("https://github.com/" + $owner + "/" + .repo),
                title: .message,
                url: .url,
                date: .date,
                meta: {}
              }
          ]')

          # Extract PR activity from events
          PR_ACTIVITY=$(echo "$EVENTS" | jq --arg owner "${GH_USER}" '[
            .[]
            | select(.type == "PullRequestEvent" and .payload.action != null)
            | {
                type: "pr",
                repo: (.repo.name | split("/") | last),
                repoUrl: ("https://github.com/" + .repo.name),
                title: (.payload.pull_request.title // "Pull request"),
                url: (.payload.pull_request.html_url // ""),
                date: .created_at,
                meta: {
                  state: (.payload.pull_request.state // ""),
                  merged: (.payload.pull_request.merged // false)
                }
              }
          ] | unique_by(.url)') || { echo "::warning::Failed to extract PR events"; PR_ACTIVITY="[]"; }

          # Extract issue activity from events
          ISSUE_ACTIVITY=$(echo "$EVENTS" | jq '[
            .[]
            | select(.type == "IssuesEvent" and .payload.action != null)
            | {
                type: "issue",
                repo: (.repo.name | split("/") | last),
                repoUrl: ("https://github.com/" + .repo.name),
                title: (.payload.issue.title // "Issue"),
                url: (.payload.issue.html_url // ""),
                date: .created_at,
                meta: {
                  state: (.payload.issue.state // "")
                }
              }
          ] | unique_by(.url)') || { echo "::warning::Failed to extract issue events"; ISSUE_ACTIVITY="[]"; }

          # Merge all activity, sort by date descending, take top 30
          RECENT_ACTIVITY=$(echo "$COMMIT_ACTIVITY" "$PR_ACTIVITY" "$ISSUE_ACTIVITY" \
            | jq -s 'add | sort_by(.date) | reverse | .[0:30]')

          # --- 8. Repositories: public, non-fork, non-archived, with languageColor ---
          REPOS=$(curl -sf \
            --connect-timeout 10 \
            --max-time 30 \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${GH_USER}/repos?sort=pushed&per_page=100&type=owner" \
          ) || { echo "::warning::Failed to fetch repositories"; REPOS="[]"; }

          echo "$REPOS" | jq empty 2>/dev/null || { echo "::warning::Invalid repos JSON"; REPOS="[]"; }

          REPOSITORIES=$(echo "$REPOS" | jq '[
            .[]
            | select((.fork // false) == false and (.archived // false) == false)
            | {
                name: .name,
                description: (.description // ""),
                language: (.language // ""),
                languageColor: (
                  (.language // "") as $lang |
                  if $lang == "Astro" then "#ff5a03"
                  elif $lang == "TypeScript" then "#3178c6"
                  elif $lang == "JavaScript" then "#f1e05a"
                  elif $lang == "Python" then "#3572A5"
                  elif $lang == "Go" then "#00ADD8"
                  elif $lang == "Rust" then "#dea584"
                  elif $lang == "Shell" then "#89e051"
                  elif $lang == "HTML" then "#e34c26"
                  elif $lang == "CSS" then "#563d7c"
                  elif $lang == "SCSS" then "#c6538c"
                  elif $lang == "Less" then "#1d365d"
                  elif $lang == "Ruby" then "#701516"
                  elif $lang == "Java" then "#b07219"
                  elif $lang == "Kotlin" then "#A97BFF"
                  elif $lang == "Swift" then "#F05138"
                  elif $lang == "C" then "#555555"
                  elif $lang == "C++" then "#f34b7d"
                  elif $lang == "C#" then "#178600"
                  elif $lang == "PHP" then "#4F5D95"
                  elif $lang == "Svelte" then "#ff3e00"
                  elif $lang == "Vue" then "#41b883"
                  elif $lang == "Lua" then "#000080"
                  elif $lang == "Dart" then "#00B4AB"
                  elif $lang == "Zig" then "#ec915c"
                  else ""
                  end
                ),
                stars: .stargazers_count,
                url: .html_url
              }
          ] | .[0:12]')

          # --- 9. Assemble final JSON ---
          jq -n \
            --arg lastUpdated "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
            --argjson contributions "$CONTRIBUTIONS" \
            --argjson calendar "$CALENDAR" \
            --argjson streak "$STREAK" \
            --argjson recentActivity "$RECENT_ACTIVITY" \
            --argjson commitsThisWeek "$COMMITS_THIS_WEEK" \
            --argjson commitsThisMonth "$COMMITS_THIS_MONTH" \
            --argjson contributionsThisWeek "$CONTRIBS_THIS_WEEK" \
            --argjson contributionsThisMonth "$CONTRIBS_THIS_MONTH" \
            --argjson repositoriesThisWeek "$REPOS_THIS_WEEK" \
            --argjson repositories "$REPOSITORIES" \
            '{
              lastUpdated: $lastUpdated,
              contributions: $contributions,
              calendar: $calendar,
              streak: $streak,
              recentActivity: $recentActivity,
              stats: {
                commitsThisWeek: $commitsThisWeek,
                commitsThisMonth: $commitsThisMonth,
                contributionsThisWeek: $contributionsThisWeek,
                contributionsThisMonth: $contributionsThisMonth,
                repositoriesThisWeek: $repositoriesThisWeek
              },
              repositories: $repositories
            }' > src/data/github.json

          # --- 10. Summary ---
          echo "Successfully fetched GitHub data"
          jq '{
            contributions_total: .contributions.total,
            calendar_weeks: (.calendar.weeks | length),
            streak_current: .streak.current,
            activity_items: (.recentActivity | length),
            repos: (.repositories | length),
            commits_this_week: .stats.commitsThisWeek,
            contributions_this_week: .stats.contributionsThisWeek
          }' src/data/github.json

      - name: Commit and push if changed
        if: steps.fetch.outcome == 'success' && hashFiles('src/data/github.json') != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/github.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: update github activity data"

            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              git pull --rebase 2>&1 || true
              if git push 2>&1; then
                echo "Push succeeded on attempt $i"
                exit 0
              fi
              echo "::warning::git push failed (attempt $i/$MAX_RETRIES)"
              sleep $((i * 5))
            done

            echo "::error::git push failed after $MAX_RETRIES attempts"
            exit 1
          else
            echo "No changes to commit"
          fi
