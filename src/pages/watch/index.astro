---
import BaseLayout from "@layouts/BaseLayout.astro";
import { breadcrumbSchema, normalizeSiteUrl, toJsonLd } from "@utils/json-ld";
import { safeUrl } from "@utils/format";

interface WatchItem {
    title: string;
    type: "movie" | "show";
    posterUrl?: string;
    url?: string;
    rating?: number;
    watchedDate?: string;
}

interface WatchingData {
    lastUpdated: string | null;
    recentlyWatched: WatchItem[];
    stats: { moviesThisMonth: number; showsThisMonth: number };
}

let watchingData: WatchingData = {
    lastUpdated: null,
    recentlyWatched: [],
    stats: { moviesThisMonth: 0, showsThisMonth: 0 },
};
try {
    watchingData = (await import("../../data/watching.json"))
        .default as WatchingData;
} catch (e) {
    if (import.meta.env.DEV) console.error("Failed to load watching data:", e);
}

const hasData = watchingData.recentlyWatched.length > 0;

const siteUrl = normalizeSiteUrl(Astro.site);
const breadcrumbJsonLd = toJsonLd(
    breadcrumbSchema([
        { name: "Home", url: siteUrl },
        { name: "Now", url: `${siteUrl}/now` },
        { name: "Watch", url: `${siteUrl}/watch` },
    ]),
);
---

<BaseLayout
    title="Watch | gwilym.ca"
    description="Movies and shows I've been watching."
    accent="p4-amber"
    breadcrumbs={[
        { label: "Home", href: "/" },
        { label: "Now", href: "/now" },
        { label: "Watch" },
    ]}
>
    <script
        type="application/ld+json"
        set:html={breadcrumbJsonLd}
        slot="head"
    />

    <main id="main-content" class="gw-watch" data-pagefind-body>
        <header class="gw-watch__header">
            <h1 class="gw-watch__title">Watch</h1>
            <p class="gw-watch__subtitle">
                Movies and shows I've been watching, tracked on <a
                    href="https://trakt.tv/users/gvns"
                    class="gw-watch__trakt-link"
                    target="_blank"
                    rel="noopener noreferrer">Trakt</a
                >.
            </p>
        </header>

        {
            !hasData && (
                <section class="gw-watch__empty-card">
                    <div class="gw-watch__empty-content">
                        <h2 class="gw-watch__empty-heading">
                            No recent activity
                        </h2>
                        <p class="gw-watch__empty-text">
                            Watch history from{" "}
                            <a
                                href="https://trakt.tv/users/gvns"
                                class="gw-watch__trakt-link"
                                target="_blank"
                                rel="noopener noreferrer"
                            >
                                Trakt
                            </a>{" "}
                            will appear here once data syncs.
                        </p>
                    </div>
                </section>
            )
        }

        {
            hasData && (
                <section class="gw-watch__grid">
                    {watchingData.recentlyWatched.map((item) => (
                        <article class="gw-watch__card">
                            <div class="gw-watch__poster-wrapper">
                                {item.posterUrl ? (
                                    <img
                                        src={item.posterUrl}
                                        alt={`Poster for ${item.title}`}
                                        class="gw-watch__poster"
                                        width="180"
                                        height="270"
                                        loading="lazy"
                                        decoding="async"
                                    />
                                ) : (
                                    <div class="gw-watch__poster-placeholder">
                                        <span
                                            class="gw-watch__poster-icon"
                                            aria-hidden="true"
                                        >
                                            &#127916;
                                        </span>
                                    </div>
                                )}
                                <span
                                    class={`gw-watch__badge ${item.type === "movie" ? "gw-watch__badge--movie" : "gw-watch__badge--show"}`}
                                >
                                    {item.type === "movie" ? "Movie" : "Show"}
                                </span>
                            </div>
                            <div class="gw-watch__card-body">
                                {(() => {
                                    const href = safeUrl(item.url);
                                    return (
                                        <h3 class="gw-watch__card-title">
                                            {href ? (
                                                <a href={href}>{item.title}</a>
                                            ) : (
                                                item.title
                                            )}
                                        </h3>
                                    );
                                })()}
                                {item.rating != null &&
                                    (() => {
                                        const raw = Number(item.rating);
                                        const r = Number.isNaN(raw)
                                            ? 0
                                            : Math.min(
                                                  5,
                                                  Math.max(0, Math.round(raw)),
                                              );
                                        return (
                                            <div
                                                class="gw-watch__rating"
                                                aria-label={`Rated ${r} out of 5`}
                                            >
                                                {Array.from({ length: 5 }).map(
                                                    (_, i) => (
                                                        <span
                                                            class={
                                                                i < r
                                                                    ? "gw-watch__star gw-watch__star--filled"
                                                                    : "gw-watch__star"
                                                            }
                                                        >
                                                            &#9733;
                                                        </span>
                                                    ),
                                                )}
                                            </div>
                                        );
                                    })()}
                                {item.watchedDate &&
                                    (() => {
                                        const d = new Date(item.watchedDate);
                                        return !Number.isNaN(d.getTime()) ? (
                                            <time
                                                class="gw-watch__date"
                                                datetime={item.watchedDate}
                                            >
                                                {d.toLocaleDateString("en-CA", {
                                                    month: "short",
                                                    day: "numeric",
                                                    year: "numeric",
                                                })}
                                            </time>
                                        ) : null;
                                    })()}
                            </div>
                        </article>
                    ))}
                </section>
            )
        }

        {
            watchingData.lastUpdated &&
                (() => {
                    const d = new Date(watchingData.lastUpdated);
                    return !Number.isNaN(d.getTime()) ? (
                        <footer class="gw-watch__updated">
                            <p>
                                Last updated:{" "}
                                <time datetime={watchingData.lastUpdated}>
                                    {d.toLocaleDateString("en-CA", {
                                        month: "long",
                                        day: "numeric",
                                        year: "numeric",
                                    })}
                                </time>
                            </p>
                        </footer>
                    ) : null;
                })()
        }
    </main>
</BaseLayout>

<style>
    .gw-watch {
        max-width: var(--width-content);
        margin: 0 auto;
    }

    .gw-watch__header {
        margin-bottom: var(--space-8);
    }

    .gw-watch__title {
        font-size: var(--text-4xl);
        line-height: 1.2;
        letter-spacing: -0.01em;
        color: var(--colour-text-primary);
        margin: 0 0 var(--space-2) 0;
    }

    .gw-watch__subtitle {
        font-size: var(--text-lg);
        color: var(--colour-text-secondary);
        margin: 0;
    }

    /* Coming soon card */
    .gw-watch__empty-card {
        border-left: var(--border-accent) solid var(--colour-p4-amber);
        background-color: var(--colour-bg-secondary);
        border-radius: 0.375rem;
        padding: var(--space-6);
        margin-bottom: var(--space-8);
    }

    .gw-watch__empty-content {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .gw-watch__empty-heading {
        font-size: var(--text-xl);
        font-family: var(--font-sans);
        color: var(--colour-p4-amber);
        margin: 0;
    }

    .gw-watch__empty-text {
        font-size: var(--text-base);
        color: var(--colour-text-secondary);
        margin: 0;
        line-height: 1.6;
    }

    .gw-watch__trakt-link {
        color: var(--colour-p4-amber);
        text-decoration: none;
    }

    .gw-watch__trakt-link:hover,
    .gw-watch__trakt-link:focus-visible {
        text-decoration: underline;
    }

    .gw-watch__trakt-link:focus-visible {
        outline: 2px solid var(--colour-p4-amber);
        outline-offset: 2px;
        border-radius: 2px;
    }

    /* Watch grid (future data) */
    .gw-watch__grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }

    .gw-watch__card {
        background-color: var(--colour-bg-secondary);
        border-radius: 0.375rem;
        overflow: hidden;
        transition:
            transform var(--transition-fast),
            box-shadow var(--transition-fast);
        border: 1px solid var(--colour-border);
    }

    .gw-watch__card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-card-hover, 0 4px 12px rgba(0, 0, 0, 0.2));
    }

    .gw-watch__poster-wrapper {
        position: relative;
        aspect-ratio: 2 / 3;
        background-color: var(--colour-bg-tertiary);
    }

    .gw-watch__poster {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gw-watch__poster-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .gw-watch__poster-icon {
        font-size: var(--text-3xl);
        opacity: 0.4;
    }

    .gw-watch__badge {
        position: absolute;
        top: var(--space-2);
        right: var(--space-2);
        font-size: var(--text-xs);
        font-weight: 600;
        padding: var(--space-1) var(--space-2);
        border-radius: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .gw-watch__badge--movie {
        background-color: var(--colour-p4-amber);
        color: var(--colour-text-inverse);
    }

    .gw-watch__badge--show {
        background-color: var(--colour-bg-tertiary);
        color: var(--colour-text-secondary);
        border: 1px solid var(--colour-border);
    }

    .gw-watch__card-body {
        padding: var(--space-3);
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .gw-watch__card-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--colour-text-primary);
        margin: 0;
        line-height: 1.4;
    }

    .gw-watch__card-title a {
        color: inherit;
        text-decoration: none;
        transition: color var(--transition-fast);
    }

    .gw-watch__card-title a:hover {
        color: var(--colour-p4-amber);
    }

    .gw-watch__rating {
        display: flex;
        gap: 1px;
    }

    .gw-watch__star {
        font-size: var(--text-sm);
        color: var(--colour-border);
    }

    .gw-watch__star--filled {
        color: var(--colour-p4-amber);
    }

    .gw-watch__date {
        font-size: var(--text-xs);
        color: var(--colour-text-muted);
    }

    /* Last updated */
    .gw-watch__updated {
        margin-top: var(--space-8);
        padding-top: var(--space-4);
        border-top: 1px solid var(--colour-border);
    }

    .gw-watch__updated p {
        font-size: var(--text-sm);
        color: var(--colour-text-muted);
        margin: 0;
    }
</style>
