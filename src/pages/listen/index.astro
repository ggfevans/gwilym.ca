---
import BaseLayout from "@layouts/BaseLayout.astro";
import { breadcrumbSchema, normalizeSiteUrl, toJsonLd } from "@utils/json-ld";
import { relativeTime, isValidMbid } from "@utils/format";

interface Listen {
    track: string;
    artist: string;
    album?: string;
    listenedAt?: string;
    caaReleaseMbid?: string | null;
    caaId?: number | null;
    recordingMbid?: string | null;
    artistMbids?: string[];
}

interface TopArtist {
    name: string;
    listenCount: number;
    artistMbid?: string | null;
}

interface TopTrack {
    track: string;
    artist: string;
    listenCount: number;
    caaReleaseMbid?: string | null;
    caaId?: number | null;
    recordingMbid?: string | null;
}

interface TopAlbum {
    album: string;
    artist: string;
    listenCount: number;
    caaReleaseMbid?: string | null;
    caaId?: number | null;
}

type SectionStatus = "ok" | "no_data" | "error";

interface ListeningData {
    lastUpdated: string | null;
    recentListens: Listen[];
    recentListensStatus: SectionStatus;
    topArtists: TopArtist[];
    topArtistsStatus: SectionStatus;
    topTracks: TopTrack[];
    topTracksStatus: SectionStatus;
    topAlbums: TopAlbum[];
    topAlbumsStatus: SectionStatus;
    stats: {
        totalListenCount: number | null;
        rangeListenCount: number | null;
        range: string;
        artistCount: number | null;
        albumCount: number | null;
        trackCount: number | null;
    };
}

const emptyData: ListeningData = {
    lastUpdated: null,
    recentListens: [],
    recentListensStatus: "ok",
    topArtists: [],
    topArtistsStatus: "ok",
    topTracks: [],
    topTracksStatus: "ok",
    topAlbums: [],
    topAlbumsStatus: "ok",
    stats: {
        totalListenCount: null,
        rangeListenCount: null,
        range: "this_month",
        artistCount: null,
        albumCount: null,
        trackCount: null,
    },
};

let listeningData: ListeningData = emptyData;
try {
    const imported = (await import("../../data/listening.json"))
        .default as Partial<ListeningData>;
    listeningData = {
        ...emptyData,
        ...imported,
        stats: { ...emptyData.stats, ...(imported.stats || {}) },
    };
} catch (e) {
    if (import.meta.env.DEV) console.error("Failed to load listening data:", e);
}

const hasData =
    (listeningData.recentListens?.length ?? 0) > 0 ||
    (listeningData.topArtists?.length ?? 0) > 0 ||
    (listeningData.topTracks?.length ?? 0) > 0 ||
    (listeningData.topAlbums?.length ?? 0) > 0;

const hasAllTimeListenCount = listeningData.stats.totalListenCount != null;
const hasRangeListenCount = listeningData.stats.rangeListenCount != null;
const rangeLabel = listeningData.stats.range.replace(/_/g, " ");

/** Construct a Cover Art Archive URL from a release MBID, or return undefined. */
function coverArtUrl(mbid: string | null | undefined): string | undefined {
    return isValidMbid(mbid)
        ? `https://coverartarchive.org/release/${mbid}/front-250`
        : undefined;
}

const siteUrl = normalizeSiteUrl(Astro.site);
const breadcrumbJsonLd = toJsonLd(
    breadcrumbSchema([
        { name: "Home", url: siteUrl },
        { name: "Now", url: `${siteUrl}/now` },
        { name: "Listen", url: `${siteUrl}/listen` },
    ]),
);
---

<BaseLayout
    title="Listen | gwilym.ca"
    description="Tracking my music via ListenBrainz."
    accent="p3-emerald"
    breadcrumbs={[
        { label: "Home", href: "/" },
        { label: "Now", href: "/now" },
        { label: "Listen" },
    ]}
>
    <script
        type="application/ld+json"
        set:html={breadcrumbJsonLd}
        slot="head"
    />

    <main id="main-content" data-pagefind-body>
        <div class="gw-listen-container">
            <header class="gw-listen-header">
                <h1>Listen</h1>
                <p class="gw-listen-subtitle">
                    Tracking my music via ListenBrainz.
                </p>
            </header>

            {
                hasData ? (
                    <div class="gw-listen-content">
                        {/* Stats bar */}
                        {(hasAllTimeListenCount || hasRangeListenCount) && (
                            <div class="gw-stats-bar">
                                {hasRangeListenCount ? (
                                    <>
                                        <span class="gw-stats-accent">
                                            {listeningData.stats.rangeListenCount?.toLocaleString()}{" "}
                                            listens
                                        </span>
                                        {" \u00b7 "}
                                        <span>{rangeLabel}</span>
                                        {hasAllTimeListenCount && (
                                            <>
                                                {" \u00b7 "}
                                                <span>
                                                    {listeningData.stats.totalListenCount?.toLocaleString()}{" "}
                                                    all time
                                                </span>
                                            </>
                                        )}
                                    </>
                                ) : (
                                    <>
                                        <span class="gw-stats-accent">
                                            {listeningData.stats.totalListenCount?.toLocaleString()}{" "}
                                            listens
                                        </span>
                                        {" \u00b7 "}
                                        <span>all time</span>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Recent listens */}
                        {listeningData.recentListens?.length > 0 &&
                            listeningData.recentListensStatus === "ok" && (
                                <section class="gw-listen-section">
                                    <h2>Recent Listens</h2>
                                    <ul class="gw-track-list">
                                        {listeningData.recentListens.map(
                                            (listen) => {
                                                const art = coverArtUrl(
                                                    listen.caaReleaseMbid,
                                                );
                                                return (
                                                    <li class="gw-track-item">
                                                        <div class="gw-track-art">
                                                            {art ? (
                                                                <img
                                                                    src={art}
                                                                    alt={`${listen.album || listen.track} album art`}
                                                                    width="48"
                                                                    height="48"
                                                                    loading="lazy"
                                                                    decoding="async"
                                                                />
                                                            ) : (
                                                                <div
                                                                    class="gw-track-art-placeholder"
                                                                    aria-hidden="true"
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        viewBox="0 0 24 24"
                                                                        fill="none"
                                                                        stroke="currentColor"
                                                                        stroke-width="1.5"
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        width="24"
                                                                        height="24"
                                                                    >
                                                                        <path d="M9 18V5l12-2v13" />
                                                                        <circle
                                                                            cx="6"
                                                                            cy="18"
                                                                            r="3"
                                                                        />
                                                                        <circle
                                                                            cx="18"
                                                                            cy="16"
                                                                            r="3"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div class="gw-track-info">
                                                            <span class="gw-track-name">
                                                                {listen.track}
                                                            </span>
                                                            <span class="gw-track-artist">
                                                                {listen.artist}
                                                            </span>
                                                        </div>
                                                        {listen.listenedAt && (
                                                            <time
                                                                class="gw-track-time"
                                                                datetime={
                                                                    listen.listenedAt
                                                                }
                                                            >
                                                                {relativeTime(
                                                                    listen.listenedAt,
                                                                )}
                                                            </time>
                                                        )}
                                                    </li>
                                                );
                                            },
                                        )}
                                    </ul>
                                </section>
                            )}

                        {/* Top artists */}
                        {listeningData.topArtists?.length > 0 &&
                            listeningData.topArtistsStatus === "ok" && (
                                <section class="gw-listen-section">
                                    <h2>Top Artists</h2>
                                    <div class="gw-artist-grid">
                                        {listeningData.topArtists.map(
                                            (artist) => (
                                                <div class="gw-artist-card">
                                                    <div class="gw-artist-image">
                                                        <div
                                                            class="gw-artist-image-placeholder"
                                                            aria-hidden="true"
                                                        >
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                viewBox="0 0 24 24"
                                                                fill="none"
                                                                stroke="currentColor"
                                                                stroke-width="1.5"
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                width="28"
                                                                height="28"
                                                            >
                                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                                                <circle
                                                                    cx="12"
                                                                    cy="7"
                                                                    r="4"
                                                                />
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    <div class="gw-artist-info">
                                                        <span class="gw-artist-name">
                                                            {artist.name}
                                                        </span>
                                                        <span class="gw-artist-plays">
                                                            {artist.listenCount}{" "}
                                                            plays
                                                        </span>
                                                    </div>
                                                </div>
                                            ),
                                        )}
                                    </div>
                                </section>
                            )}

                        {/* Top tracks */}
                        {listeningData.topTracks?.length > 0 &&
                            listeningData.topTracksStatus === "ok" && (
                                <section class="gw-listen-section">
                                    <h2>Top Tracks</h2>
                                    <ul class="gw-track-list">
                                        {listeningData.topTracks.map(
                                            (track) => {
                                                const art = coverArtUrl(
                                                    track.caaReleaseMbid,
                                                );
                                                return (
                                                    <li class="gw-track-item">
                                                        <div class="gw-track-art">
                                                            {art ? (
                                                                <img
                                                                    src={art}
                                                                    alt={`${track.track} album art`}
                                                                    width="48"
                                                                    height="48"
                                                                    loading="lazy"
                                                                    decoding="async"
                                                                />
                                                            ) : (
                                                                <div
                                                                    class="gw-track-art-placeholder"
                                                                    aria-hidden="true"
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        viewBox="0 0 24 24"
                                                                        fill="none"
                                                                        stroke="currentColor"
                                                                        stroke-width="1.5"
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        width="24"
                                                                        height="24"
                                                                    >
                                                                        <path d="M9 18V5l12-2v13" />
                                                                        <circle
                                                                            cx="6"
                                                                            cy="18"
                                                                            r="3"
                                                                        />
                                                                        <circle
                                                                            cx="18"
                                                                            cy="16"
                                                                            r="3"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div class="gw-track-info">
                                                            <span class="gw-track-name">
                                                                {track.track}
                                                            </span>
                                                            <span class="gw-track-artist">
                                                                {track.artist}
                                                            </span>
                                                        </div>
                                                        <span class="gw-track-time">
                                                            {track.listenCount}{" "}
                                                            plays
                                                        </span>
                                                    </li>
                                                );
                                            },
                                        )}
                                    </ul>
                                </section>
                            )}

                        {/* Top albums */}
                        {listeningData.topAlbums?.length > 0 &&
                            listeningData.topAlbumsStatus === "ok" && (
                                <section class="gw-listen-section">
                                    <h2>Top Albums</h2>
                                    <div class="gw-artist-grid">
                                        {listeningData.topAlbums.map(
                                            (album) => {
                                                const art = coverArtUrl(
                                                    album.caaReleaseMbid,
                                                );
                                                return (
                                                    <div class="gw-artist-card">
                                                        <div class="gw-artist-image">
                                                            {art ? (
                                                                <img
                                                                    src={art}
                                                                    alt={`${album.album} cover art`}
                                                                    class="gw-artist-image--square"
                                                                    width="64"
                                                                    height="64"
                                                                    loading="lazy"
                                                                    decoding="async"
                                                                />
                                                            ) : (
                                                                <div
                                                                    class="gw-artist-image-placeholder"
                                                                    aria-hidden="true"
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        viewBox="0 0 24 24"
                                                                        fill="none"
                                                                        stroke="currentColor"
                                                                        stroke-width="1.5"
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        width="28"
                                                                        height="28"
                                                                    >
                                                                        <path d="M9 18V5l12-2v13" />
                                                                        <circle
                                                                            cx="6"
                                                                            cy="18"
                                                                            r="3"
                                                                        />
                                                                        <circle
                                                                            cx="18"
                                                                            cy="16"
                                                                            r="3"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div class="gw-artist-info">
                                                            <span class="gw-artist-name">
                                                                {album.album}
                                                            </span>
                                                            <span class="gw-track-artist">
                                                                {album.artist}
                                                            </span>
                                                            <span class="gw-artist-plays">
                                                                {
                                                                    album.listenCount
                                                                }{" "}
                                                                plays
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            },
                                        )}
                                    </div>
                                </section>
                            )}

                        {/* Last updated */}
                        {listeningData.lastUpdated && (
                            <p class="gw-last-updated">
                                Last updated{" "}
                                <time datetime={listeningData.lastUpdated}>
                                    {new Date(
                                        listeningData.lastUpdated,
                                    ).toLocaleString("en-CA", {
                                        day: "numeric",
                                        month: "long",
                                        year: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                    })}
                                </time>
                            </p>
                        )}
                    </div>
                ) : (
                    <div class="gw-listen-empty">
                        <div class="gw-empty-icon" aria-hidden="true">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                width="48"
                                height="48"
                            >
                                <path d="M9 18V5l12-2v13" />
                                <circle cx="6" cy="18" r="3" />
                                <circle cx="18" cy="16" r="3" />
                            </svg>
                        </div>
                        <p class="gw-empty-message">
                            ListenBrainz integration coming soon.
                        </p>
                        <p class="gw-empty-detail">
                            This page will show what I have been listening to
                            once the data pipeline is wired up.
                        </p>
                    </div>
                )
            }
        </div>
    </main>
</BaseLayout>

<style>
    .gw-listen-container {
        max-width: var(--width-content);
        margin-inline: auto;
        padding-inline: var(--space-6);
    }

    .gw-listen-header {
        margin-bottom: var(--space-8);
    }

    .gw-listen-header h1 {
        font-size: var(--text-4xl);
        font-weight: 700;
        letter-spacing: -0.02em;
        line-height: 1.1;
        margin-bottom: var(--space-2);
    }

    .gw-listen-subtitle {
        font-size: var(--text-lg);
        color: var(--colour-text-secondary);
    }

    /* Stats bar */
    .gw-stats-bar {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-sm);
        font-family: var(--font-mono);
        color: var(--colour-text-secondary);
        background: var(--colour-bg-secondary);
        border: 1px solid var(--colour-border);
        border-radius: 6px;
        padding: var(--space-2) var(--space-4);
        margin-bottom: var(--space-8);
    }

    .gw-stats-accent {
        color: var(--colour-p3-emerald);
        font-weight: 600;
    }

    /* Sections */
    .gw-listen-section {
        margin-bottom: var(--space-12);
    }

    .gw-listen-section h2 {
        font-size: var(--text-xl);
        font-weight: 600;
        margin-bottom: var(--space-6);
        letter-spacing: -0.01em;
    }

    /* Track list */
    .gw-track-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .gw-track-item {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        padding: var(--space-3) var(--space-4);
        border-radius: 8px;
        transition: background var(--transition-fast);
    }

    .gw-track-item:hover {
        background: var(--colour-bg-secondary);
    }

    .gw-track-art img,
    .gw-track-art-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .gw-track-art img {
        object-fit: cover;
    }

    .gw-track-art-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--colour-bg-tertiary);
        color: var(--colour-text-muted);
    }

    .gw-track-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
        flex: 1;
    }

    .gw-track-name {
        font-size: var(--text-base);
        font-weight: 500;
        color: var(--colour-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .gw-track-artist {
        font-size: var(--text-sm);
        color: var(--colour-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .gw-track-time {
        font-size: var(--text-xs);
        font-family: var(--font-mono);
        color: var(--colour-text-muted);
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Artist grid */
    .gw-artist-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: var(--space-4);
    }

    .gw-artist-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-6) var(--space-4);
        background: var(--colour-bg-secondary);
        border: 1px solid var(--colour-border);
        border-radius: 8px;
        transition: border-color var(--transition-fast);
        text-align: center;
    }

    .gw-artist-card:hover {
        border-color: var(--colour-p3-emerald);
    }

    .gw-artist-image img,
    .gw-artist-image-placeholder {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .gw-artist-image img {
        object-fit: cover;
    }

    .gw-artist-image--square {
        border-radius: 6px;
    }

    .gw-artist-image-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--colour-bg-tertiary);
        color: var(--colour-text-muted);
    }

    .gw-artist-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
        width: 100%;
    }

    .gw-artist-name {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--colour-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .gw-artist-plays {
        font-size: var(--text-xs);
        font-family: var(--font-mono);
        color: var(--colour-p3-emerald);
    }

    /* Last updated */
    .gw-last-updated {
        font-size: var(--text-sm);
        color: var(--colour-text-muted);
        margin-top: var(--space-8);
        padding-top: var(--space-4);
        border-top: 1px solid var(--colour-border);
    }

    /* Empty state */
    .gw-listen-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: var(--space-16) var(--space-6);
        gap: var(--space-4);
    }

    .gw-empty-icon {
        color: var(--colour-p3-emerald);
        opacity: 0.6;
        margin-bottom: var(--space-2);
    }

    .gw-empty-message {
        font-size: var(--text-lg);
        font-weight: 500;
        color: var(--colour-text-primary);
    }

    .gw-empty-detail {
        font-size: var(--text-base);
        color: var(--colour-text-secondary);
        max-width: 40ch;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .gw-listen-header h1 {
            font-size: var(--text-3xl);
        }

        .gw-track-art img,
        .gw-track-art-placeholder {
            width: 40px;
            height: 40px;
        }

        .gw-artist-grid {
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        }
    }
</style>
