---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import PostCard from "@components/PostCard.astro";
import { breadcrumbSchema, normalizeSiteUrl, toJsonLd } from "@utils/json-ld";

export async function getStaticPaths() {
    const posts = await getCollection("writing", ({ data }) => {
        return import.meta.env.PROD ? !data.draft : true;
    });

    // Get all unique tags
    const tags = new Set<string>();
    posts.forEach((post) => {
        post.data.tags.forEach((tag) => tags.add(tag));
    });

    return [...tags].map((tag) => ({
        params: { tag },
        props: {
            tag,
            posts: posts
                .filter((post) => post.data.tags.includes(tag))
                .sort(
                    (a, b) =>
                        b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
                ),
        },
    }));
}

interface Props {
    tag: string;
    posts: Awaited<ReturnType<typeof getCollection<"writing">>>;
}

const { tag, posts } = Astro.props;

const siteUrl = normalizeSiteUrl(Astro.site);
const breadcrumbJsonLd = toJsonLd(
    breadcrumbSchema([
        { name: "Home", url: siteUrl },
        { name: "Write", url: `${siteUrl}/write` },
        { name: "Tags", url: `${siteUrl}/write/tags` },
        { name: tag, url: `${siteUrl}/write/tags/${encodeURIComponent(tag)}` },
    ]),
);
---

<BaseLayout
    title={`Posts tagged "${tag}" | gwilym.ca`}
    description={`All writing posts tagged with ${tag}.`}
    accent="p4-amber"
    breadcrumbs={[
        { label: "Home", href: "/" },
        { label: "Write", href: "/write" },
        { label: "Tags", href: "/write/tags" },
        { label: tag },
    ]}
>
    <script
        type="application/ld+json"
        set:html={breadcrumbJsonLd}
        slot="head"
    />
    <main id="main-content" class="tag-page">
        <header>
            <h1>Posts tagged: <span class="tag-name">{tag}</span></h1>
            <p class="count">
                {posts.length} post{posts.length !== 1 ? "s" : ""}
            </p>
        </header>

        <div class="post-list">
            {posts.map((post) => <PostCard post={post} />)}
        </div>
    </main>
</BaseLayout>

<style>
    .tag-page {
        max-width: var(--width-content);
        margin: 0 auto;
    }

    header {
        margin-bottom: 2rem;
    }

    h1 {
        font-size: var(--text-2xl);
        line-height: 1.3;
        margin-bottom: 0.25rem;
    }

    .tag-name {
        color: var(--colour-accent-primary);
    }

    .count {
        color: var(--colour-text-secondary);
        font-size: var(--text-sm);
    }

    .post-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
</style>
