---
import type { ActivityItem, ActivityType } from '@utils/github';
import { activityIconPath, activityLabel } from '@utils/github';
import { relativeTime, truncate, safeUrl } from '@utils/format';

interface Props {
  activities: ActivityItem[];
}

const { activities } = Astro.props;

// Group activities by date (YYYY-MM-DD)
function groupByDate(items: ActivityItem[]): Map<string, ActivityItem[]> {
  const groups = new Map<string, ActivityItem[]>();
  for (const item of items) {
    const dateKey = item.date.split('T')[0];
    const existing = groups.get(dateKey) || [];
    existing.push(item);
    groups.set(dateKey, existing);
  }
  return groups;
}

function formatDateHeader(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const yesterday = new Date(now.getTime() - 86400000).toISOString().split('T')[0];

  if (dateStr === today) return 'Today';
  if (dateStr === yesterday) return 'Yesterday';
  return d.toLocaleDateString('en-CA', { weekday: 'long', month: 'short', day: 'numeric' });
}

function statusBadge(item: ActivityItem): string | null {
  if (item.type === 'pr' && item.meta?.merged) return 'merged';
  if (item.type === 'pr' && item.meta?.state === 'CLOSED') return 'closed';
  if (item.type === 'issue' && item.meta?.state === 'CLOSED') return 'closed';
  if (item.type === 'pr' && item.meta?.state === 'OPEN') return 'open';
  if (item.type === 'issue' && item.meta?.state === 'OPEN') return 'open';
  return null;
}

const grouped = groupByDate(activities);

// Global index counter for alternating sides across all groups
let globalIndex = 0;
---

<div class="gw-timeline">
  {activities.length === 0 ? (
    <p class="gw-timeline__empty">No recent activity.</p>
  ) : (
    [...grouped.entries()].map(([dateKey, items]) => (
      <div class="gw-timeline__group">
        <div class="gw-timeline__date-row">
          <hr class="gw-timeline__date-line" aria-hidden="true" />
          <h3 class="gw-timeline__date-header">{formatDateHeader(dateKey)}</h3>
          <hr class="gw-timeline__date-line" aria-hidden="true" />
        </div>

        <ol class="gw-timeline__list" role="list">
          {items.map((item) => {
            const badge = statusBadge(item);
            const href = safeUrl(item.url);
            const repoHref = safeUrl(item.repoUrl);
            const isEven = globalIndex % 2 === 0;
            globalIndex++;

            const contentBlock = (
              <div class="gw-timeline__card" data-time={relativeTime(item.date)}>
                <div class="gw-timeline__header">
                  {repoHref ? (
                    <a href={repoHref} class="gw-timeline__repo" target="_blank" rel="noopener noreferrer">
                      {item.repo}
                    </a>
                  ) : (
                    <span class="gw-timeline__repo">{item.repo}</span>
                  )}
                  <span class="gw-timeline__type">{activityLabel(item.type)}</span>
                  {badge && (
                    <span class={`gw-timeline__badge gw-timeline__badge--${badge}`}>{badge}</span>
                  )}
                </div>
                {href ? (
                  <a href={href} class="gw-timeline__title" target="_blank" rel="noopener noreferrer">
                    {truncate(item.title, 80)}
                  </a>
                ) : (
                  <span class="gw-timeline__title">{truncate(item.title, 80)}</span>
                )}
              </div>
            );

            const timeBlock = (
              <time class="gw-timeline__time" datetime={item.date}>
                {relativeTime(item.date)}
              </time>
            );

            return (
              <li class={`gw-timeline__item ${isEven ? 'gw-timeline__item--left' : 'gw-timeline__item--right'}`}>
                <div class="gw-timeline__start">
                  {isEven ? timeBlock : contentBlock}
                </div>

                <div class="gw-timeline__middle">
                  <div class={`gw-timeline__dot gw-timeline__dot--${item.type}`} aria-hidden="true">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path d={activityIconPath(item.type)} />
                    </svg>
                  </div>
                  <div class="gw-timeline__connector" aria-hidden="true" />
                </div>

                <div class="gw-timeline__end">
                  {isEven ? contentBlock : timeBlock}
                </div>
              </li>
            );
          })}
        </ol>
      </div>
    ))
  )}
</div>

<style>
  .gw-timeline {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .gw-timeline__empty {
    margin: 0;
    padding: var(--space-4);
    border: 1px dashed var(--colour-border);
    border-radius: var(--radius-md);
    color: var(--colour-text-muted);
    font-size: var(--text-sm);
    background: var(--colour-bg-secondary);
  }

  /* Date header row — centered with lines extending to each side */
  .gw-timeline__date-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .gw-timeline__date-line {
    flex: 1;
    border: none;
    border-top: 1px solid var(--colour-border);
    margin: 0;
  }

  .gw-timeline__date-header {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--colour-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
    white-space: nowrap;
  }

  /* List reset */
  .gw-timeline__list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  /* Each timeline item: 3-column grid — left | center | right */
  .gw-timeline__item {
    display: grid;
    grid-template-columns: 1fr 40px 1fr;
    gap: 0;
    padding-bottom: var(--space-4);
    position: relative;
  }

  .gw-timeline__item:last-child {
    padding-bottom: 0;
  }

  .gw-timeline__item:last-child .gw-timeline__connector {
    display: none;
  }

  /* Left region */
  .gw-timeline__start {
    display: flex;
    justify-content: flex-end;
    padding-right: var(--space-3);
    padding-top: var(--space-1);
  }

  /* Right region */
  .gw-timeline__end {
    display: flex;
    justify-content: flex-start;
    padding-left: var(--space-3);
    padding-top: var(--space-1);
  }

  /* Time alignment — push to edge nearest the dot */
  .gw-timeline__item--left .gw-timeline__start {
    align-items: flex-start;
  }

  .gw-timeline__item--left .gw-timeline__time {
    text-align: right;
  }

  .gw-timeline__item--right .gw-timeline__end {
    align-items: flex-start;
  }

  .gw-timeline__item--right .gw-timeline__time {
    text-align: left;
  }

  /* Card alignment — text flows toward the edge */
  .gw-timeline__item--left .gw-timeline__end .gw-timeline__card {
    text-align: left;
  }

  .gw-timeline__item--right .gw-timeline__start .gw-timeline__card {
    text-align: right;
  }

  .gw-timeline__item--right .gw-timeline__start .gw-timeline__header {
    justify-content: flex-end;
  }

  /* Center column — dot + connector line */
  .gw-timeline__middle {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .gw-timeline__dot {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--colour-bg-secondary);
    border: 2px solid var(--colour-border);
    color: var(--colour-text-muted);
    position: relative;
    z-index: 1;
    flex-shrink: 0;
  }

  .gw-timeline__dot--commit {
    border-color: var(--colour-p1-violet);
    color: var(--colour-p1-violet);
  }

  .gw-timeline__dot--pr {
    border-color: var(--colour-p3-emerald);
    color: var(--colour-p3-emerald);
  }

  .gw-timeline__dot--issue {
    border-color: var(--colour-p4-amber);
    color: var(--colour-p4-amber);
  }

  .gw-timeline__connector {
    flex: 1;
    width: 1px;
    background: var(--colour-border);
    min-height: var(--space-4);
  }

  /* Card styling */
  .gw-timeline__card {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-3) var(--space-4);
    background: var(--colour-bg-secondary);
    border: 1px solid var(--colour-border);
    border-radius: 8px;
    max-width: 100%;
    transition: border-color var(--transition-fast);
  }

  .gw-timeline__card:hover {
    border-color: color-mix(in srgb, var(--colour-p1-violet) 40%, var(--colour-border));
  }

  .gw-timeline__header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .gw-timeline__repo {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--colour-p1-violet);
    text-decoration: none;
    font-weight: 500;
    transition: color var(--transition-fast);
  }

  .gw-timeline__repo:hover {
    color: var(--colour-p1-violet-hover);
  }

  .gw-timeline__type {
    font-size: var(--text-xs);
    color: var(--colour-text-muted);
  }

  /* Status badges */
  .gw-timeline__badge {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 1px 6px;
    border-radius: 10px;
  }

  .gw-timeline__badge--merged {
    background: color-mix(in srgb, var(--colour-p1-violet) 20%, transparent);
    color: var(--colour-p1-violet);
  }

  .gw-timeline__badge--closed {
    background: color-mix(in srgb, var(--colour-error) 20%, transparent);
    color: var(--colour-error);
  }

  .gw-timeline__badge--open {
    background: color-mix(in srgb, var(--colour-p3-emerald) 20%, transparent);
    color: var(--colour-p3-emerald);
  }

  /* Title link */
  .gw-timeline__title {
    font-size: var(--text-sm);
    color: var(--colour-text-primary);
    text-decoration: none;
    line-height: 1.4;
    transition: color var(--transition-fast);
  }

  a.gw-timeline__title:hover {
    color: var(--colour-p1-violet);
  }

  /* Timestamp */
  .gw-timeline__time {
    font-size: var(--text-xs);
    color: var(--colour-text-muted);
    padding-top: var(--space-2);
  }

  /* Responsive: collapse to single-side on mobile */
  @media (max-width: 640px) {
    .gw-timeline__item {
      grid-template-columns: 28px 1fr;
      gap: 0 var(--space-2);
    }

    .gw-timeline__middle {
      grid-column: 1;
      grid-row: 1 / -1;
    }

    /* Hide the empty side */
    .gw-timeline__item--left .gw-timeline__start,
    .gw-timeline__item--right .gw-timeline__end {
      display: none;
    }

    /* Show content side in the second column */
    .gw-timeline__item--left .gw-timeline__end,
    .gw-timeline__item--right .gw-timeline__start {
      grid-column: 2;
      grid-row: 1;
      padding-left: var(--space-2);
      padding-right: 0;
      justify-content: flex-start;
    }

    /* Reset text alignment on mobile */
    .gw-timeline__item--right .gw-timeline__start .gw-timeline__card {
      text-align: left;
    }

    .gw-timeline__item--right .gw-timeline__start .gw-timeline__header {
      justify-content: flex-start;
    }

    /* Show time inside the card on mobile */
    .gw-timeline__card::after {
      content: attr(data-time);
      font-size: var(--text-xs);
      color: var(--colour-text-muted);
    }

    .gw-timeline__dot {
      width: 24px;
      height: 24px;
    }

    .gw-timeline__dot svg {
      width: 12px;
      height: 12px;
    }
  }
</style>
