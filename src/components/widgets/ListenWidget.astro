---
import { relativeTime, isValidMbid } from '@utils/format';

interface Props { compact?: boolean; }
const { compact = false } = Astro.props;

interface Listen {
  track: string;
  artist: string;
  album?: string;
  listenedAt?: string;
  caaReleaseMbid?: string | null;
  caaId?: number | null;
  recordingMbid?: string | null;
  artistMbids?: string[];
}

type SectionStatus = 'ok' | 'no_data' | 'error';

interface ListeningData {
  lastUpdated: string | null;
  recentListens: Listen[];
  recentListensStatus: SectionStatus;
  topArtists: { name: string; listenCount: number; artistMbid?: string | null }[];
  topArtistsStatus: SectionStatus;
  topTracks: { track: string; artist: string; listenCount: number; caaReleaseMbid?: string | null; caaId?: number | null; recordingMbid?: string | null }[];
  topTracksStatus: SectionStatus;
  topAlbums: { album: string; artist: string; listenCount: number; caaReleaseMbid?: string | null; caaId?: number | null }[];
  topAlbumsStatus: SectionStatus;
  stats: { totalListenCount: number | null; range: string; artistCount: number | null; albumCount: number | null; trackCount: number | null };
}

const emptyData: ListeningData = {
  lastUpdated: null,
  recentListens: [],
  recentListensStatus: 'ok',
  topArtists: [],
  topArtistsStatus: 'ok',
  topTracks: [],
  topTracksStatus: 'ok',
  topAlbums: [],
  topAlbumsStatus: 'ok',
  stats: { totalListenCount: null, range: 'this_month', artistCount: null, albumCount: null, trackCount: null },
};

let data: ListeningData = emptyData;
try {
  const imported = (await import('../../data/listening.json')).default as Partial<ListeningData>;
  data = { ...emptyData, ...imported, stats: { ...emptyData.stats, ...(imported.stats || {}) } };
} catch (e) {
  if (import.meta.env.DEV) console.error('Failed to load listening data for ListenWidget:', e);
}

const latestTrack = data.recentListens?.[0] ?? null;
const artUrl = isValidMbid(latestTrack?.caaReleaseMbid)
  ? `https://coverartarchive.org/release/${latestTrack.caaReleaseMbid}/front-250`
  : undefined;
---

{compact ? (
  <article class="gw-widget-compact gw-widget-compact--listen">
    <div class="gw-widget-compact__label">Now Listening</div>
    {latestTrack ? (
      <a href="/listen" class="gw-widget-compact__body">
        {artUrl && (
          <img src={artUrl} alt={`${latestTrack.album || latestTrack.track} album art`} class="gw-widget-compact__cover gw-widget-compact__cover--square" width="40" height="40" loading="lazy" decoding="async" />
        )}
        <div class="gw-widget-compact__info">
          <p class="gw-widget-compact__title">{latestTrack.track}</p>
          <p class="gw-widget-compact__subtitle">{latestTrack.artist}</p>
        </div>
      </a>
    ) : (
      <p class="gw-widget-compact__empty">Nothing playing.</p>
    )}
  </article>
) : (
  <article class="gw-widget gw-widget--listen">
    <div class="gw-widget__label">Listen</div>
    {latestTrack ? (
      <div class="gw-widget__content gw-widget__content--row">
        {artUrl ? (
          <img
            src={artUrl}
            alt={`${latestTrack.album || latestTrack.track} album art`}
            class="gw-widget__art"
            width="64"
            height="64"
            loading="lazy"
            decoding="async"
          />
        ) : (
          <div class="gw-widget__art-placeholder" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
          </div>
        )}
        <div>
          <p class="gw-widget__detail gw-widget__detail--bold">{latestTrack.track}</p>
          <p class="gw-widget__meta">{latestTrack.artist}</p>
          {latestTrack.listenedAt && (
            <time class="gw-widget__time" datetime={latestTrack.listenedAt}>
              {relativeTime(latestTrack.listenedAt)}
            </time>
          )}
        </div>
      </div>
    ) : (
      <p class="gw-widget__empty">Nothing playing right now.</p>
    )}
    <a href="/listen" class="gw-widget__link">
      View Full Activity <span aria-hidden="true">&rarr;</span>
    </a>
  </article>
)}

<style>
  .gw-widget--listen {
    border-left-color: var(--colour-p3-emerald);
  }

  .gw-widget--listen .gw-widget__link:hover {
    color: var(--colour-p3-emerald);
  }

  .gw-widget__art {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-md);
    object-fit: cover;
    flex-shrink: 0;
  }

  .gw-widget__art-placeholder {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-md);
    background: var(--colour-bg-tertiary);
    color: var(--colour-text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .gw-widget-compact--listen {
    border-top: var(--border-accent) solid var(--colour-p3-emerald);
  }

  .gw-widget-compact__cover--square {
    border-radius: var(--radius-md);
  }
</style>
