---
import { getCollection } from 'astro:content';
import { formatDate } from '@utils/date';

interface Props { compact?: boolean; }
const { compact = false } = Astro.props;

const posts = (await getCollection('writing'))
  .filter((p) => (import.meta.env.PROD ? !p.data.draft : true))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const latestPost = posts[0] ?? null;
const postSlug = latestPost?.slug.split('/').pop();
---

{compact ? (
  <article class="gw-widget-compact gw-widget-compact--write">
    <div class="gw-widget-compact__label">Latest Post</div>
    {latestPost ? (
      <a href={`/write/${postSlug}`} class="gw-widget-compact__body">
        <div class="gw-widget-compact__info">
          <p class="gw-widget-compact__title">{latestPost.data.title}</p>
          <p class="gw-widget-compact__subtitle">{formatDate(latestPost.data.pubDate)}</p>
        </div>
      </a>
    ) : (
      <p class="gw-widget-compact__empty">No posts yet.</p>
    )}
  </article>
) : (
  <article class="gw-widget gw-widget--write">
    <div class="gw-widget__label">Write</div>
    {latestPost ? (
      <div class="gw-widget__content">
        <a href={`/write/${postSlug}`} class="gw-widget__post-link">
          <p class="gw-widget__detail gw-widget__detail--bold">{latestPost.data.title}</p>
        </a>
        <time class="gw-widget__time" datetime={latestPost.data.pubDate.toISOString()}>
          {formatDate(latestPost.data.pubDate)}
        </time>
        <p class="gw-widget__excerpt">{latestPost.data.description}</p>
      </div>
    ) : (
      <p class="gw-widget__empty">No posts yet.</p>
    )}
    <a href="/write" class="gw-widget__link">
      View Full Activity <span aria-hidden="true">&rarr;</span>
    </a>
  </article>
)}

<style>
  .gw-widget--write {
    border-left-color: var(--colour-p4-amber);
  }

  .gw-widget--write .gw-widget__link:hover {
    color: var(--colour-p4-amber);
  }

  .gw-widget__post-link {
    text-decoration: none;
    color: inherit;
  }

  .gw-widget__post-link:hover .gw-widget__detail {
    color: var(--colour-p4-amber);
  }

  .gw-widget__excerpt {
    font-size: var(--text-sm);
    color: var(--colour-text-secondary);
    margin: var(--space-2) 0 0 0;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .gw-widget-compact--write {
    border-top: var(--border-accent) solid var(--colour-p4-amber);
  }
</style>
