---
import { relativeTime, safeUrl } from '@utils/format';

interface Props { compact?: boolean; }
const { compact = false } = Astro.props;

interface WatchItem {
  title: string;
  type: string;
  posterUrl?: string;
  watchedDate?: string;
}

interface WatchingData {
  lastUpdated: string | null;
  recentlyWatched: WatchItem[];
  stats: { moviesThisMonth: number; showsThisMonth: number };
}

let data: WatchingData = { lastUpdated: null, recentlyWatched: [], stats: { moviesThisMonth: 0, showsThisMonth: 0 } };
try {
  const imported = (await import('../../data/watching.json')).default as Partial<WatchingData>;
  data = {
    lastUpdated: imported.lastUpdated ?? null,
    recentlyWatched: Array.isArray(imported.recentlyWatched) ? imported.recentlyWatched : [],
    stats: imported.stats && typeof imported.stats === 'object'
      ? { moviesThisMonth: imported.stats.moviesThisMonth ?? 0, showsThisMonth: imported.stats.showsThisMonth ?? 0 }
      : { moviesThisMonth: 0, showsThisMonth: 0 },
  };
} catch (e) {
  if (import.meta.env.DEV) console.error('Failed to load watching data for WatchWidget:', e);
}

const latestWatch = data.recentlyWatched[0] ?? null;
const posterSrc = safeUrl(latestWatch?.posterUrl);
const watchedDate = latestWatch?.watchedDate && !Number.isNaN(new Date(latestWatch.watchedDate).getTime())
  ? latestWatch.watchedDate
  : null;
---

{compact ? (
  <article class="gw-widget-compact gw-widget-compact--watch">
    <div class="gw-widget-compact__label">Now Watching</div>
    {latestWatch ? (
      <a href="/watch" class="gw-widget-compact__body">
        {posterSrc && (
          <img src={posterSrc} alt={`Poster for ${latestWatch.title}`} class="gw-widget-compact__cover" width="40" height="60" loading="lazy" decoding="async" />
        )}
        <div class="gw-widget-compact__info">
          <p class="gw-widget-compact__title">{latestWatch.title}</p>
          <p class="gw-widget-compact__subtitle">{latestWatch.type}</p>
        </div>
      </a>
    ) : (
      <p class="gw-widget-compact__empty">Nothing watched.</p>
    )}
  </article>
) : (
  <article class="gw-widget gw-widget--watch">
    <div class="gw-widget__label">Watch</div>
    {latestWatch ? (
      <div class="gw-widget__content gw-widget__content--row">
        {posterSrc && (
          <img
            src={posterSrc}
            alt={`Poster for ${latestWatch.title}`}
            class="gw-widget__poster"
            width="48"
            height="72"
            loading="lazy"
            decoding="async"
          />
        )}
        <div>
          <p class="gw-widget__detail gw-widget__detail--bold">{latestWatch.title}</p>
          <p class="gw-widget__meta">{latestWatch.type}</p>
          {watchedDate && (
            <time class="gw-widget__time" datetime={watchedDate}>
              {relativeTime(watchedDate)}
            </time>
          )}
        </div>
      </div>
    ) : (
      <p class="gw-widget__empty">Nothing watched recently.</p>
    )}
    <a href="/watch" class="gw-widget__link">
      View Full Activity <span aria-hidden="true">&rarr;</span>
    </a>
  </article>
)}

<style>
  .gw-widget--watch {
    border-left-color: var(--colour-p4-amber);
  }

  .gw-widget--watch .gw-widget__link:hover {
    color: var(--colour-p4-amber);
  }

  .gw-widget__poster {
    border-radius: var(--radius-md);
    object-fit: cover;
    flex-shrink: 0;
  }

  .gw-widget-compact--watch {
    border-top: var(--border-accent) solid var(--colour-p4-amber);
  }
</style>
